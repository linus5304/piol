name: Claude PR Assistant

on:
  issue_comment:
    types: [created]

# Only run on PR comments that mention @claude
jobs:
  claude-assist:
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            return {
              head_sha: pr.data.head.sha,
              base_sha: pr.data.base.sha,
              title: pr.data.title,
              body: pr.data.body || ''
            };

      - name: Get PR diff
        id: diff
        run: |
          git diff ${{ fromJSON(steps.pr.outputs.result).base_sha }}...${{ fromJSON(steps.pr.outputs.result).head_sha }} > pr_diff.txt
          echo "diff_size=$(wc -c < pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Extract command from comment
        id: command
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            // Extract everything after @claude
            const match = comment.match(/@claude\s+(.+)/is);
            return match ? match[1].trim() : 'Please review this PR and provide feedback.';

      - name: Call Claude API
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the diff (truncate if too large)
          DIFF_CONTENT=$(head -c 100000 pr_diff.txt)
          
          # Prepare the prompt
          PROMPT=$(cat <<'PROMPT_EOF'
          You are a helpful code review assistant. A developer has asked for your help with a pull request.
          
          PR Title: ${{ fromJSON(steps.pr.outputs.result).title }}
          
          Developer's request: ${{ steps.command.outputs.result }}
          
          Here is the diff of the changes:
          
          ```diff
          ${DIFF_CONTENT}
          ```
          
          Please provide helpful, actionable feedback. Be concise but thorough.
          If the request is to review the code, focus on:
          - Potential bugs or issues
          - Security concerns
          - Performance considerations
          - Code style and best practices
          - Suggestions for improvement
          
          Format your response in markdown.
          PROMPT_EOF
          )
          
          # Make API call to Claude
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 4096,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $(echo "$PROMPT" | jq -Rs .)
              }]
            }")
          
          # Extract the response text
          CLAUDE_RESPONSE=$(echo "$RESPONSE" | jq -r '.content[0].text // "Error: Unable to get response from Claude"')
          
          # Save to file for the next step (handles multiline)
          echo "$CLAUDE_RESPONSE" > claude_response.md

      - name: Post Claude's response
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const response = fs.readFileSync('claude_response.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `### Claude's Response\n\n${response}\n\n---\n*Powered by Claude AI*`
            });
